#:kivy 1.0.9
#:import utils kivy.utils
#:import Clock kivy.clock.Clock
#:import run backend.asyncrun.run
#:import sqrt math.sqrt

#:import ZBarCam kivy_garden.zbarcam.ZBarCam
#:import ZBarSymbol pyzbar.pyzbar.ZBarSymbol

#:set superbright utils.get_color_from_hex("#ffffff")
#:set superdark utils.get_color_from_hex("#000000")
#:set bright utils.get_color_from_hex("#787878")
#:set dark utils.get_color_from_hex("#121212")
#:set background utils.get_color_from_hex("#3B3B3B")
#:set lightbackground  utils.get_color_from_hex("#2E2E2E")
#:set buttonbackground utils.get_color_from_hex("#aaaaaa")
#:set error utils.get_color_from_hex("#aa0000")


# <Widget>:
#     canvas.after:
#         Line:
#             rectangle: self.x+1,self.y+1,self.width-1,self.height-1
#             dash_offset: 5
#             dash_length: 3

<BaseWidget>:
    canvas.before:
        Color:
            rgb: dark
        Rectangle:
            size: self.size
            pos: self.pos
<BaseWidget1>:
    canvas.before:
        Color:
            rgb: lightbackground
        Rectangle:
            size: self.size
            pos: self.pos

<BaseScreen>:
    canvas.before:
        Color:
            rgb: dark
        Rectangle:
            size: self.size
            pos: self.pos
<BaseScreen1>:
    canvas.before:
        Color:
            rgb: lightbackground
        Rectangle:
            size: self.size
            pos: self.pos

<KVNotifications>:
    size: 0, 0
    size_hint: 0, 0
    Button:
        pos: (self.parent.rwidth-self.width)/2, self.parent.rheight - self.height - 6
        disabled: True
        background_color: bright[0:3] + [100]
        color: bright[0:3] + [100]
        size_hint: 1, None
        size: self.parent.rwidth *.95, self.parent.rheight * .07

        Label:
            halign:'center'
            valign:'middle'
            pos: self.parent.pos
            size: self.parent.size
            text: "Hello World"
            color: error
            text_size: self.size


<KVPOPup>:
    size: 0, 0
    size_hint: 0, 0
    BoxLayout:
        orientation: "vertical"
        padding: 10

        canvas.before:
            Color:
                rgb: dark
            Rectangle:
                size: self.size
                pos: self.pos

        pos: (self.parent.rwidth-self.width)/2, (self.parent.rheight - self.height )/2
        background_color: bright[0:3] + [100]
        color: bright[0:3] + [100]
        size_hint: 1, 1
        size: self.parent.rwidth *.9, self.parent.rheight * .9


<KVPOPupShair>:
    Label:
        text: "err"
        font_size: 30
        size_hint: 1, .1

    Image:
        source: "app/images/logo.png"
        size_hint: 1, .9

    Button:
        text: "Done"
        size_hint: 1, .1
        on_press: run(self.parent.parent.close())


<KVPOPupChangeName>:

    Label:
        size_hint: 1, .1
        text: "Change username"

    TextInput:
        size_hint: 1, .2
        multiline: False
        text: self.parent.parent.sm.session["name"]

    Widget:
        size_hint: 1, .4

    Button:
        text: "Ok"
        size_hint: 1, .1
        on_press: run(self.parent.parent.change())
    Button:
        text: "Cancel"
        size_hint: 1, .1
        on_press: run(self.parent.parent.close())

<KVPOPupSearch>:

    Label:
        size_hint: 1, .1
        text: "Scan QR code"


    ZBarCam:
        id: "camera"
        size_hint: 1, .9
        # code_types: ZBarSymbol.QRCODE

    Label:
        size_hint: 1, .1
        text: "Enter id"

    TextInput:
        size_hint: 1, .2
        multiline: False
        text: ""

    Widget:
        size_hint: 1, .4

    Button:
        text: "Ok"
        size_hint: 1, .1
        on_press: run(self.parent.parent.go())
    Button:
        text: "Cancel"
        size_hint: 1, .1
        on_press: run(self.parent.parent.close())


<KVPOPupAddUser>:

    Label:
        size_hint: 1, .1
        text: "Add user"

    Image:
        size_hint: 1, .4
        source: self.parent.parent.user.img

    Label:
        size_hint: 1, .1
        text: self.parent.parent.user.username
    Label:
        size_hint: 1, .1
        text_size: self.size
        halign:'center'
        valign:'middle'
        text: self.parent.parent.user.userid

    Widget:
        size_hint: 1, .2

    Button:
        text: "Add"
        size_hint: 1, .1
        on_press: run(self.parent.parent.go())
    Button:
        text: "Cancel"
        size_hint: 1, .1
        on_press: run(self.parent.parent.close())



<LoginPage>:
    BoxLayout:
        size_hint: None, None
        orientation: "vertical"
        size: self.parent.width * .9, self.parent.height *.9
        pos: (root.width - self.width) /2, (root.height - self.height) /2

        Label:
            pos: ((root.width - self.width) / 2), ((root.height - self.height) / 2) + 3*root.height /8
            text: ""
            color: error
        TextInput:
            hint_text: 'Username'
            multiline: False
            font_size: 16
            pos: ((root.width - self.width) / 2), ((root.height - self.height) / 2) + 2*root.height /8
            width: 0.9 * root.width
            background_color: background
            foreground_color: superbright
            hint_text_color: bright
            size_hint: 1, .25

        GridLayout:
            cols: 2
            rows: 2
            spacing: 10
            width: 0.6 * root.width
            pos: ((root.width - self.width) / 2) - root.width/8, ((root.height - self.height) / 2) + root.height / 8
        
            CheckBox:
                id: licence
                size_hint_x: root.width * 0.08

            Label:
                text: " I accept this license agreement."
                halign:'left'
                valign:'middle'
                size_hint_x: root.width * 0.9
                text_size: self.size

            CheckBox:
                id: terms
                size_hint_x: 1

            Label:
                text: " I accept these terms of use."
                halign:'left'
                valign:'middle'
                size_hint_x: root.width * 0.9
                text_size: self.size

        BoxLayout:
            orientation: "vertical"
            width: self.parent.width * .9
            pos: ((root.width - self.width) / 2), ((root.height - self.height) / 2) - root.height /7

            Button:
                text: "Sign up"
                width: 0.9 * root.width
                height: 30
                color: superbright
                background_color: buttonbackground
                hint_text_color: bright
                border_width: 0

                on_press: self.parent.parent.parent.signup()

            Widget:
                size_hint: 1, 1

            Label:
                text: "Already have an account?"

            Button:
                text: "Import account"
                width: 0.9 * root.width
                height: 30
                color: superbright
                background_color: buttonbackground
                hint_text_color: bright
                border_width: 0

                on_press: run(self.parent.parent.parent.login())


        Image:
            source: "app/images/logo.png"
            size_hint: None, None
            size: self.parent.width, self.parent.height *.2
            center: self.parent.width/2, self.parent.children[1].pos[1] / 2
            allow_stretch: True



<User>:
    size_hint: 1, None
    Button:
        background_color: 0,0,0,0
        pos: self.parent.pos
        width: self.parent.width
        on_press: run(self.parent.press())
    BoxLayout:
        orientation: "horizontal"
        width: sqrt(root.width) * 0.95
        size_hint: 1, 1
        pos: (sqrt(root.width) - self.width) / 2, self.parent.pos[1]
        spacing: 10
        height: self.parent.height

        Image:
            source: self.parent.parent.img
            size_hint: .7, .99
            width: self.parent.width * 0.2

        Label:
            font_size: 25
            text: self.parent.parent.username
            size_hint_x: 2.5
            halign:'left'
            valign:'middle'
            text_size: self.size
            spacing: 10

        Label:
            _tmp: [self.parent.parent.userid[x:x+2] for x in range(0, 12, 2)] #  "00 00 00\n00 00 00"
            text: " ".join(self._tmp[0:3]) + "\n" + " ".join(self._tmp[3:6])
            size_hint_x: .9

<UserProperty>:
    size_hint: 1, .25

<UserPropertySpace>:
    size_hint: 1, .1

<UserPropertyButton>:
    Button:
        size_hint: 1, None
        width: sqrt(self.parent.width)
        height: self.parent.height
        text: self.parent.name
        pos: self.parent.pos
        on_press: run(self.parent.event())


<UserPropertyPage>:
    size_hint: 1, 1
    pos: 0, 0

    Button:
        text: "Cancel"
        size_hint: 1, .1
        pos: 0, self.parent.height-self.height
        on_press: run(self.parent.back())

    ScrollView:
        do_scroll_x: False
        do_scroll_y: True
        size_hint: 1, .9
        size: root.width, self.parent.height

        ScrollLayout:
            orientation: "tb-lr"
            size_hint_x: root.width
            size: root.width, sum([x.size[1] for x in self.children]) + self.spacing[1]*len(self.children) + 50
            spacing: 2


<UsersPage>:
    size_hint: 1, 1
    pos: 0, 0


    BoxLayout:
        orientation: "vertical"
        size: root.width, root.height
        

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, .1
            padding: 5
            spacing: self.width/100

            Button:
                background_color: 0,0,0,0
                size_hint: .2, 1
                on_press: run(self.parent.parent.parent.userproperties())
                Image:
                    source: self.parent.parent.parent.parent.user.img
                    size: self.parent.width, self.parent.height
                    center: self.parent.center_x, self.parent.pos[1] + self.parent.height/2
                    allow_stretch: True

            Label:
                font_size: 25
                text: self.parent.parent.parent.user.username
                halign:'left'
                valign:'middle'
                text_size: self.size

            Button:
                background_color: 0,0,0,0
                size_hint_x: .1
                on_press: run(self.parent.parent.parent.search())
                Image:
                    source: "app/images/search.png"
                    size: self.parent.width, self.parent.height
                    center: self.parent.center_x, self.parent.pos[1] + self.parent.height/2
                    allow_stretch: True
            Widget:
                size_hint: 0.01, 1
            Button:
                background_color: 0,0,0,0
                size_hint_x: .1
                on_press: run(self.parent.parent.parent.shaire())
                Image:
                    source: "app/images/shaire.png"
                    size: self.parent.width, self.parent.height
                    center: self.parent.center_x, self.parent.pos[1] + self.parent.height/2
                    allow_stretch: True
            
        BaseWidget:
            size_hint: 1, .002
            height: 5

        BaseWidget1:
            size_hint: 1, .002
            height: 5

        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            size_hint: 1, .9
            size: root.width, self.parent.height

            ScrollLayout:
                orientation: "tb-lr"
                size_hint_x: root.width
                size: root.width, sum([x.size[1] for x in self.children]) + self.spacing[1]*len(self.children) + 50
                spacing: 2

<MessageImg>:
    size_hint: None, None
    pos: 10, self.pos[1]
    source: self.user.img

    radius: 2
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(self.colour)
        Line:
            points: self.pos[0]-self.radius, self.pos[1] + self.radius, self.pos[0]-self.radius, self.pos[1] + self.size[1] - self.radius
        Color:
            rgba: superbright


<Message>:
    disabled: True
    size_hint: None, None
    height: self.minimum_height
    width: self.get_width()
    foreground_color: utils.get_color_from_hex(self.foreground_colora)
    pos: 10, self.pos[1]
    background_color: (0, 1, 0, 0)
    radius: 2
    canvas.before:
        Color:
            rgba: utils.get_color_from_hex(self.colour)
        Line:
            points: self.pos[0]-self.radius, self.pos[1] + self.radius, self.pos[0]-self.radius, self.pos[1] + self.size[1] - self.radius
        Color:
            rgba: utils.get_color_from_hex(self.foreground_colora)

<MessagePage>:
    BoxLayout:
        orientation:"vertical"
        BoxLayout: # fix this at some point
            orientation:"horizontal"
            size_hint: 1, None
            height: self.parent.height * 0.07
            Button:
                text:"Back"
                on_press: run(self.parent.parent.parent.back())
            Label:
                text:"test2 (testmode)"
        Widget:
            size_hint: 1, .01

        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            size_hint: 1, .9
            size: root.width, self.parent.height

            ScrollLayout:
                orientation: "tb-lr"
                size_hint_x: root.width
                size: root.width, sum([x.size[1] for x in self.children]) + self.spacing[1]*len(self.children) + 50
                spacing: 5

        BoxLayout:
            orientation: "horizontal"
            width: self.parent.width
            height: self.children[1].size[1]
            size_hint_y: None

            canvas.before:
                Color:
                    rgb: lightbackground
                Rectangle:
                    size: self.size
                    pos: self.pos

            TextInput:
                background_color: lightbackground
                on_text: Clock.schedule_once(lambda x: self.parent.parent.parent.update(self.parent, self.parent.parent.children[1], self), 0)
                canvas.after: Clock.schedule_once(lambda x: self.parent.parent.parent.update(self.parent, self.parent.parent.children[1], self), 1)
                hint_text: 'Send message'
                font_size: 18
                background_color: background
                foreground_color: superbright

                background_normal: 'app/images/background.png'
                background_active: 'app/images/background.png'

                border: 30, 30, 30, 30

                hint_text_color: bright
                size_hint: .8, None
                padding: 20
                height: max(min(5*self.line_height*1.5, self.minimum_height), self.parent.children[0].children[0].width * 1.3)

            Button:
                size_hint: .1, None
                height: self.width*1.3
                background_color: 0,0,0,0
                on_press: run(self.parent.parent.parent.send())
                Image:
                    source: "app/images/send.png"
                    size: self.parent.width, self.parent.height
                    center: self.parent.center_x + self.parent.width/100, self.parent.center_y + self.parent.height/100
                    allow_stretch: True


<SeedgenPage>:
    BoxLayout:
        size_hint: None, None
        orientation: "vertical"
        size: self.parent.width * .9, self.parent.height *.9
        pos: (root.width - self.width) /2, (root.height - self.height) /2
        spacing: 10

        Label:
            size_hint: 1, .4
            text_size: self.size
            text: "Remember or write down this seed it is important and will be necessary to log into your account.\nNOTE: Do not write it on any digital device (especialy online) as that can be a security risk."

        Widget:
            size_hint: 1, .1
        TextInput:
            size_hint: 1, .4
            background_normal: 'app/images/background.png'
            background_active: 'app/images/background.png'
            background_disabled_normal: 'app/images/background.png'
            disabled_foreground_color: superdark

            border: 30, 30, 30, 30
            padding: 20
            disabled: True

            text: "Generating secure key..."
            canvas.after: Clock.schedule_once(lambda x: self.parent.parent.update(self), 0)

        Widget:
            size_hint: 1, .1

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, .2

            Button:
                size_hint: .4, .5
                text: "Back"
                on_press: self.parent.parent.parent.back()

            Widget:
                size_hint: .2, 1

            Button:
                size_hint: .4, .5
                text: "Next"
                on_press: self.parent.parent.parent.next()

# this is basicly duplicated code couldn't be bothered to fix
<ImportPage>:
    BoxLayout:
        size_hint: None, None
        orientation: "vertical"
        size: self.parent.width * .9, self.parent.height *.9
        pos: (root.width - self.width) /2, (root.height - self.height) /2
        spacing: 10

        Label:
            size_hint: 1, .2
            text_size: self.size
            halign:'center'
            valign:'middle'
            text: ""
            color: error

        Label:
            size_hint: 1, .4
            text_size: self.size
            text: "Enter the words for your seed below separated by a space.\nIf you have forgotten your seed try remember where you wrote it down as it is impossible to recover an account without it."
        Widget:
            size_hint: 1, .1
        TextInput:
            size_hint: 1, .4
            background_normal: 'app/images/background.png'
            background_active: 'app/images/background.png'
            background_disabled_normal: 'app/images/background.png'
            disabled_foreground_color: superdark

            border: 30, 30, 30, 30
            padding: 20

            text_hint: "Enter your seed."

        Widget:
            size_hint: 1, .1

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, .2

            Button:
                size_hint: .4, .5
                text: "Back"
                on_press: self.parent.parent.parent.back()

            Widget:
                size_hint: .2, 1

            Button:
                size_hint: .4, .5
                text: "Next"
                on_press: run(self.parent.parent.parent.next())